# MechMania IV: Web-Based Observer with VNC
# Access the game through a web browser on any OS

FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install dependencies including X11, VNC, and web server
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    libsdl2-dev \
    libsdl2-image-dev \
    libsdl2-ttf-dev \
    pkg-config \
    xvfb \
    x11vnc \
    novnc \
    websockify \
    supervisor \
    fluxbox \
    xterm \
    net-tools \
    && rm -rf /var/lib/apt/lists/*

# Copy and build MechMania
WORKDIR /build
COPY . .
RUN mkdir -p build && cd build && \
    cmake .. && \
    make -j$(nproc)

# Setup the runtime environment
WORKDIR /app
RUN cp -r /build/build/* . && \
    cp -r /build/team/src/gfx . && \
    cp /build/team/src/graphics.reg .

# Create supervisor configuration
RUN mkdir -p /etc/supervisor/conf.d
RUN echo '[supervisord]\n\
nodaemon=true\n\
user=root\n\
\n\
[program:xvfb]\n\
command=/usr/bin/Xvfb :99 -screen 0 1280x960x24 -ac\n\
autorestart=true\n\
stdout_logfile=/var/log/xvfb.log\n\
stderr_logfile=/var/log/xvfb.err\n\
\n\
[program:fluxbox]\n\
command=/usr/bin/fluxbox\n\
environment=DISPLAY=":99"\n\
autorestart=true\n\
stdout_logfile=/var/log/fluxbox.log\n\
stderr_logfile=/var/log/fluxbox.err\n\
\n\
[program:x11vnc]\n\
command=/usr/bin/x11vnc -display :99 -nopw -listen 0.0.0.0 -forever -shared\n\
autorestart=true\n\
stdout_logfile=/var/log/x11vnc.log\n\
stderr_logfile=/var/log/x11vnc.err\n\
\n\
[program:novnc]\n\
command=/usr/share/novnc/utils/launch.sh --vnc localhost:5900 --listen 6080\n\
autorestart=true\n\
stdout_logfile=/var/log/novnc.log\n\
stderr_logfile=/var/log/novnc.err\n' \
> /etc/supervisor/conf.d/supervisord.conf

# Create startup script
RUN echo '#!/bin/bash\n\
echo "Starting MechMania IV Web Interface..."\n\
echo "=================================="\n\
echo "Open your browser to:"\n\
echo "  http://localhost:6080/vnc.html"\n\
echo "=================================="\n\
\n\
# Start supervisor to manage all services\n\
/usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf &\n\
\n\
# Wait for X server to be ready\n\
sleep 5\n\
\n\
# Set display\n\
export DISPLAY=:99\n\
\n\
# Start the game based on MODE environment variable\n\
case "${MODE}" in\n\
    observer)\n\
        echo "Starting Observer in reconnect mode..."\n\
        cd /app && ./mm4obs -R -G -p${PORT:-2323} -h${HOST:-localhost}\n\
        ;;\n\
    server)\n\
        echo "Starting Server..."\n\
        cd /app && ./mm4serv -p${PORT:-2323} -h${HOST:-0.0.0.0}\n\
        ;;\n\
    game)\n\
        echo "Starting complete game..."\n\
        cd /app && ./run_game.sh\n\
        ;;\n\
    *)\n\
        echo "Starting default game with observer..."\n\
        cd /app && xterm -e ./run_game.sh &\n\
        cd /app && ./mm4obs -R -G -p2323 -hlocalhost\n\
        ;;\n\
esac\n' \
> /app/start.sh

RUN chmod +x /app/start.sh

# Expose ports
EXPOSE 5900 6080 2323

# Environment variables for configuration
ENV MODE=game
ENV PORT=2323
ENV HOST=localhost
ENV DISPLAY=:99

CMD ["/app/start.sh"]